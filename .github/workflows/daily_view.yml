name: IHDS Daily View Fetcher

on:
  # å®šæ—¶è¿è¡Œï¼šæ¯å¤© UTC 0:00 (åŒ—äº¬æ—¶é—´ 8:00)
  schedule:
    - cron: '0 0 * * *'
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# è®¾ç½®æƒé™ï¼Œå…è®¸æ¨é€ä»£ç 
permissions:
  contents: write

jobs:
  fetch-daily-view:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. è¿è¡ŒæŠ“å–è„šæœ¬
      - name: Fetch Daily View
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "ğŸ” Python ç‰ˆæœ¬: $(python --version)"
          echo "ğŸ” å½“å‰ç›®å½•: $(pwd)"
          echo "ğŸ” ç›®å½•ç»“æ„:"
          ls -la
          ls -la src/ihds/
          echo ""
          echo "ğŸš€ å¼€å§‹è¿è¡ŒæŠ“å–è„šæœ¬..."
          python main.py
          echo "âœ… Daily View æŠ“å–å®Œæˆ"
          echo ""
          echo "ğŸ“‚ è¾“å‡ºæ–‡ä»¶:"
          ls -la output/daily_views/ || echo "output/daily_views/ ä¸å­˜åœ¨"
      
      # 5. è·å–ä»Šæ—¥ä¿¡æ¯ç”¨äºæäº¤æ¶ˆæ¯
      - name: Get today's info
        id: info
        run: |
          # è®¾ç½®æ—¥æœŸ
          DATE=$(date +%Y-%m-%d)
          echo "date=$DATE" >> $GITHUB_OUTPUT
          
          # è¯»å–æœ€æ–°çš„è‹±æ–‡æ–‡ä»¶è·å– Gate ä¿¡æ¯
          if [ -f "output/daily_views/latest_en.md" ]; then
            GATE_INFO=$(head -1 output/daily_views/latest_en.md | sed 's/# //')
            echo "gate_info=$GATE_INFO" >> $GITHUB_OUTPUT
            echo "ğŸ“– Gate ä¿¡æ¯: $GATE_INFO"
          else
            echo "gate_info=Daily View" >> $GITHUB_OUTPUT
            echo "âš ï¸ latest_en.md æ–‡ä»¶ä¸å­˜åœ¨"
          fi
      
      # 6. æäº¤å¹¶æ¨é€æ›´æ”¹
      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # æ·»åŠ æ‰€æœ‰è¾“å‡ºæ–‡ä»¶
          git add output/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–°çš„æ›´æ”¹éœ€è¦æäº¤"
          else
            git commit -m "ğŸ“… Daily View: ${{ steps.info.outputs.gate_info }} (${{ steps.info.outputs.date }})"
            git push
            echo "âœ… å·²æäº¤å¹¶æ¨é€åˆ°ä»“åº“"
          fi
      
      # 7. å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆæˆåŠŸæ—¶ï¼‰
      - name: Send success email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âœ¨ IHDS Daily View - ${{ steps.info.outputs.gate_info }}"
          to: ${{ secrets.EMAIL_TO }}
          from: "IHDS Daily Bot <${{ secrets.EMAIL_USERNAME }}>"
          body: |
            ğŸŒŸ ä»Šæ—¥ Human Design Daily View å·²æ›´æ–°ï¼
            
            ğŸ“… æ—¥æœŸï¼š${{ steps.info.outputs.date }}
            ğŸšª Gateï¼š${{ steps.info.outputs.gate_info }}
            
            ğŸ“‚ æŸ¥çœ‹ä»“åº“ï¼š${{ github.server_url }}/${{ github.repository }}
            
            ---
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€
      
      # 8. å‘é€å¤±è´¥é€šçŸ¥
      - name: Send failure email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âŒ IHDS Daily View æŠ“å–å¤±è´¥ - ${{ steps.info.outputs.date }}"
          to: ${{ secrets.EMAIL_TO }}
          from: "IHDS Daily Bot <${{ secrets.EMAIL_USERNAME }}>"
          body: |
            âš ï¸ ä»Šæ—¥ Daily View æŠ“å–å¤±è´¥ï¼
            
            ğŸ“… æ—¥æœŸï¼š${{ steps.info.outputs.date }}
            ğŸ”— æŸ¥çœ‹æ—¥å¿—ï¼š${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            è¯·æ£€æŸ¥è¿è¡Œæ—¥å¿—æ’æŸ¥é—®é¢˜ã€‚
